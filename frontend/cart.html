<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang ch·ªß c·ª≠a h√†ng</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="main-header">
  <div class="container header-container">
    <h1 class="logo">üõçÔ∏è C·ª≠a h√†ng Online</h1>
    <nav class="main-nav">
      <ul class="nav-links">
        <li><a href="index.html">Trang ch·ªß</a></li>
        <li><a href="#">S·∫£n ph·∫©m</a></li>
        <li><a href="cart.html">Gi·ªè h√†ng</a></li>
      </ul>
    </nav>
    <div class="auth-buttons" id="auth-section">
      <!-- X·ª≠ l√Ω b·ªüi JS -->
    </div>
    <script src="js/auth.js"></script>
  </div>
</header>

<main class="container">
  <h2 class="section-title">S·∫£n ph·∫©m trong gi·ªè h√†ng</h2>
  <div id="cart-items" class="product-grid"></div>
  <h3 id="total-price"></h3>
  <button onclick="checkout()">Thanh to√°n</button>
</main>

<footer class="main-footer">
  <p>&copy; 2025 Shop c·ªßa b·∫°n. All rights reserved.</p>
</footer>

<script>
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const cartItemsContainer = document.getElementById('cart-items');
  const totalPriceEl = document.getElementById('total-price');

  function renderCart() {
    cartItemsContainer.innerHTML = '';
    let total = 0;

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = '<p>Gi·ªè h√†ng tr·ªëng.</p>';
      totalPriceEl.innerText = '';
      return;
    }

    cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <h3>${item.name}</h3>
        <strong>${item.price.toLocaleString()} $</strong>
        <button onclick="removeItem('${item.id}')">X√≥a kh·ªèi gi·ªè</button>
      `;
      cartItemsContainer.appendChild(div);
      total += Number(item.price);
    });

    totalPriceEl.innerText = `T·ªïng c·ªông: ${total.toLocaleString()} $`;
  }

  function removeItem(id) {
    const index = cart.findIndex(item => item.id === id);
    if (index > -1) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }
  }

  async function checkout() {
    if (cart.length === 0) {
      alert('Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
      return;
    }

    const pureCart = cart.map(item => ({
      id: item.id,
      name: item.name,
      price: item.price,
      quantity: item.quantity || 1,
      image: item.image
    }));

    console.log('Cart hi·ªán t·∫°i:', pureCart);

    try {
      const response = await fetch('http://localhost:3000/api/checkout/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cartItems: pureCart })
      });

      const data = await response.json();

      if (response.ok && data.url) {
        window.location.href = data.url;
      } else {
        console.error('Server tr·∫£ v·ªÅ l·ªói:', data);
        alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o thanh to√°n.');
      }
    } catch (error) {
      console.error('L·ªói khi thanh to√°n:', error);
      alert('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n.');
    }
  }

  renderCart();
</script>
</body>
</html>
